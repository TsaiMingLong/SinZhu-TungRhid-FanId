meta:
    project: opennmt

alias=qionpu: # 全部
  tasks: [hazoi-ngiliau, don-ngiliau, zunpi-ngiliau, hiunlien, ]

job=hazoi-ngiliau: # 下載語料
  use: hazoi_docker
  command: |
    bash -eux -c '
      python nginziin.py
    '
  mounts: [ngienbun_ngiliau, ]

job=don-ngiliau: # 斷詞斷字語料
  use: hazoi_docker
  command: |
    bash -eux -c '
      cat /ngienbun-ngiliau/meu.txt | sed "s/\(.\)/\1 /g" \
        | head -n 500 > /doncii-ngiliau/meu.valid
      cat /ngienbun-ngiliau/meu.txt | sed "s/\(.\)/\1 /g" \
        | tail -n +501 > /doncii-ngiliau/meu.train
      cat /ngienbun-ngiliau/fa.txt  | sed "s/\(.\)/\1 /g" \
        | head -n 500 > /doncii-ngiliau/fa.valid
      cat /ngienbun-ngiliau/fa.txt  | sed "s/\(.\)/\1 /g" \
        | tail -n +501 > /doncii-ngiliau/fa.train
    '
  mounts: [ngienbun_ngiliau, doncii_ngiliau, ]

mount=ngienbun_ngiliau: # 原本語料
  bind: ./1-ngienbun-ngiliau/
  path: /ngienbun-ngiliau/

mount=doncii_ngiliau: # 斷詞語料
  bind: ./2-doncii-ngiliau/
  path: /doncii-ngiliau/

mount=opennmt_data:
  bind: ./3-opennmt-data/
  path: /data/

mount=opennmt_model:
  bind: ./4-opennmt-model/
  path: /model/

mount=glove:
  # https://opennmt.net/OpenNMT-py/FAQ.html#how-do-i-use-pretrained-embeddings-e-g-glove
  bind: ./glove_dir/
  path: /glove_dir/
  read-only: true

image=hazoi_docker:
  image: hazoi-docker
  context: hazoi-docker

image=opennmt_docker:
  image: opennmt-docker
  context: opennmt-docker

job=zunpi-ngiliau:
  use: opennmt_docker
  command: |
    bash -eux -c '
      onmt_build_vocab -config tin.yaml -n_sample -1
    '
  mounts: [doncii_ngiliau, opennmt_data]

job=hiunlien:
  use: opennmt_docker
  command: |
    bash -eux -c '
      onmt_train -config tin.yaml
    '
  mounts: [doncii_ngiliau, opennmt_data, opennmt_model, glove]

job=fan:
  use: opennmt_docker
  command: |
    bash -eux -c '
      echo "詞 是 最 小 有 意 義 且 可 以 自 由 使 用 的 語 言 單 位" > fa.txt
      echo "詞 是 最 小 有 意義 且 可以 自由 使用 的 語言 單位" >> fa.txt
      echo "詞是最小有意義且可以自由使用的語言單位" >> fa.txt
      onmt_translate -model /model/meufa-model_step_100000.pt -src fa.txt -output pred-meu.txt -replace_unk -verbose # -gpu_ranks 0
      cat pred-meu.txt
    '
  mounts: [opennmt_data, opennmt_model]
