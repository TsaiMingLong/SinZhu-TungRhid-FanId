meta:
    project: opennmt

alias=zunpi-ngiliau:
  tasks: [hazoi-ngiliau, zunpi-ngiliau,toncii, hiunlien]

job=hazoi-ngiliau: # 下載語料
  use: hazoi_docker
  command: |
    bash -eux -c '
      python nginziin.py
      cp ngiliau/* /ngiliau/
    '
  mounts: [ngienbun_giliau, ]

job=zunpi-giliau:
  use: hazoi_docker
  command: |
    bash -eux -c '
 
      cat /ngienbun_giliau/meu.txt | sed 's/\(.\)/\1 /g' \
        | head -n -1000 > /doncii_giliau/meu.train
      cat /ngienbun_giliau/meu.txt | sed 's/\(.\)/\1 /g' \
        | tail -n 1000 > /doncii_giliau/meu.valid
      cat /ngienbun_giliau/fa.txt  | sed 's/\(.\)/\1 /g' \
        | head -n -1000 > /doncii_giliau/fa.train
      cat /ngienbun_giliau/fa.txt  | sed 's/\(.\)/\1 /g' \
        | tail -n 1000 > /doncii_giliau/fa.valid
    '
  mounts: [ngienbun_giliau, doncii_giliau, ]

mount=ngienbun_giliau: # 原本語料
  bind: ./1-ngienbun-giliau/
  path: /ngienbun-giliau/

mount=doncii_ngiliau: # 斷詞語料
  bind: ./2-doncii-ngiliau/
  path: /doncii-ngiliau/

mount=data:
  bind: ./{env.PANPUN}-data/
  path: /data/

mount=model:
    bind: ./{env.PANPUN}-model/
    path: /model/

image=ngiliau_docker:
  image: ngiliau_docker
  context: ngiliau_docker

image=opennmt-docker:
  image: opennmt-docker
  context: opennmt-docker

job=hua-tngsu:
  use: tngsu
  command: python tngsu.py /huetshut_e_giliau/ /tngsu_giliau/
  mounts: [huetshut_e_giliau, tngsu_giliau, ]
     


job=taihua-preprocess:
  use: hunlian-khuanking
  command: |
    bash -eux -c '
      onmt_preprocess \
        -train_src /giliau/taigi.train \
        -train_tgt /giliau/huagi.train \
        -valid_src /giliau/taigi.valid \
        -valid_tgt /giliau/huagi.valid \
        -save_data /data/
    '
  mounts: [giliau, data]

job=huatai-preprocess:
  use: hunlian-khuanking
  command: |
    bash -eux -c '
      onmt_preprocess \
        -train_src /giliau/huagi.train \
        -train_tgt /giliau/taigi.train \
        -valid_src /giliau/huagi.valid \
        -valid_tgt /giliau/taigi.valid \
        -save_data /data/
    '
  mounts: [giliau, data]

job=hunlian:
  use: hunlian-khuanking
  command: |
    bash -eux -c '
      onmt_train -data /data/ -save_model /model/demo-model -gpu_ranks 0
    '
  mounts: [data, model]

job=huan:
  use: hunlian-khuanking
  command: |
    bash -eux -c '
      echo "詞 是 最 小 有 意義 且 可以 自由 使用 的 語言 單位" > hua.txt
      echo "詞是最小有意義且可以自由使用的語言單位" >> hua.txt
      echo "逐-家｜tak8-ke1 做-伙｜tso3-hue2 來｜lai5 𨑨-迌｜tshit4-tho5 ！｜!" >> hua.txt
      onmt_translate -model /model/demo-model_step_100000.pt -src hua.txt -output pred-tai.txt -replace_unk -verbose # -gpu_ranks 0
      cat pred-tai.txt
    '
  mounts: [data, model]
